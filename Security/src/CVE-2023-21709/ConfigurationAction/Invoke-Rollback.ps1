# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\..\..\..\Shared\Invoke-ScriptBlockHandler.ps1
. $PSScriptRoot\..\..\..\..\Shared\Write-ErrorInformation.ps1

function Invoke-Rollback {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string[]]$ExchangeServers
    )

    begin {
        $FailedServers =  New-Object 'System.Collections.Generic.List[string]'
        $NoImpactServers =  New-Object 'System.Collections.Generic.List[string]'

        $progressParams = @{
            Activity        = "Adding TokenCachingModule"
            Status          = [string]::Empty
            PercentComplete = 0
        }

        Write-Verbose "Calling: $($MyInvocation.MyCommand)"

        $ConfigureRollback = {
            $results = @{
                IsRollbackRequired = $true
                IsSuccessful       = $false
                ErrorContext       = $null
            }

            try {
                if ($null -ne (Get-WebGlobalModule -Name "TokenCacheModule")) {
                    $results.IsRollbackRequired = $false
                    return $results
                }

                New-WebGlobalModule -Name "TokenCacheModule" -Image "%windir%\System32\inetsrv\cachtokn.dll" -ErrorAction Stop

                if (-not $WhatIfPreference) {
                    if ($null -ne (Get-WebGlobalModule -Name "TokenCacheModule")) {
                        $results.IsSuccessful = $true
                    }
                }
            } catch {
                $results.ErrorContext = $_
            }

            return $results
        }
    } process {
        $counter = 0
        $totalCount = $ExchangeServers.Count

        if ($WhatIfPreference) {
            Write-Host ("What if: Will perform the below actions on the following servers: {0}" -f [string]::Join(", ", $ExchangeServers))
        }

        foreach ($Server in $ExchangeServers) {
            $baseStatus = "Processing: $Server -"
            $progressParams.PercentComplete = ($counter / $totalCount * 100)
            $progressParams.Status = "$baseStatus Rollback mitigation"
            Write-Progress @progressParams

            $counter ++;

            if (-not $WhatIfPreference -or ($Server).Split(".")[0] -eq $env:COMPUTERNAME) {
                Write-Verbose ("Calling Invoke-ScriptBlockHandler on Server {0}" -f $Server)
                $resultsInvoke = Invoke-ScriptBlockHandler -ComputerName $Server -ScriptBlock $ConfigureRollback
            }

            if (-not $WhatIfPreference) {
                if ($null -eq $resultsInvoke) {
                    Write-Warning ("Server {0} is unavailable. Skipping it!" -f $Server)
                    $FailedServers += $Server
                    continue;
                }

                if (-not $resultsInvoke.IsRollbackRequired) {
                    Write-Verbose ("Rollback is not required on server {0}" -f $Server)
                    $NoImpactServers += $Server
                    continue
                }

                if ($resultsInvoke.IsSuccessful) {
                    Write-Verbose ("Successfully rollback mitigation on server {0}" -f $Server)
                } else {
                    Write-Host ("Script failed to rollback mitigation on server {0}" -f $Server) -ForegroundColor Red
                    $FailedServers += $Server
                    continue
                }
            }
        }
    } end {
        Write-Progress @progressParams -Completed

        if (-not $WhatIfPreference) {
            if ($FailedServers.Length -gt 0) {
                Write-Host ("Unable to rollback mitigation of following servers: {0}" -f [string]::Join(", ", $FailedServers)) -ForegroundColor Red
            }

            if ($NoImpactServers.Length -gt 0) {
                Write-Host ("No rollback required for the following servers : {0}" -f [string]::Join(", ", $NoImpactServers))
            }
        }
    }
}

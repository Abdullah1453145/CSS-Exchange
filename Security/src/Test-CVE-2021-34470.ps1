# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

[CmdletBinding()]
param (
    [Parameter()]
    [switch]
    $ApplyFix
)

$ErrorActionPreference = "Stop"

$schemaMaster = (netdom query fsmo | Select-String "Schema master\s+(\S+)").Matches.Groups[1].Value

$schemaDN = ([ADSI]"LDAP://$($schemaMaster)/RootDSE").schemaNamingContext

$storageGroupSchemaEntryDN = "LDAP://$($schemaMaster)/CN=ms-Exch-Storage-Group,$schemaDN"

if (-not ([System.DirectoryServices.DirectoryEntry]::Exists($storageGroupSchemaEntryDN))) {
    Write-Host "Exchange was not installed in this forest. Therefore, CVE-2021-34470 vulnerability is not present."
    return
}

$storageGroupSchemaEntry = [ADSI]($storageGroupSchemaEntryDN)
if ($storageGroupSchemaEntry.Properties["possSuperiors"].Count -eq 0) {
    Write-Host "CVE-2021-34470 vulnerability is not present."
    return
}

$hasUnexpectedValues = $false

foreach ($val in $storageGroupSchemaEntry.Properties["possSuperiors"]) {
    if ($val -eq "computer") {
        Write-Warning "CVE-2021-34470 vulnerability is present."
    } else {
        $hasUnexpectedValues = $true
        Write-Warning "CVE-2021-34470 vulnerability may be present due to an unexpected superior: $val"
    }
}

if ($ApplyFix) {
    if ($hasUnexpectedValues) {
        $OutputFile = "$PSScriptRoot\Test-CVE-2021-34470.log"
        "Attempting fix at $(Get-Date)." | Out-File $OutputFile -Append
        "Value prior to fix:" | Out-File $OutputFile -Append
        $storageGroupSchemaEntry.Properties["possSuperiors"] | Out-File $OutputFile -Append
    }

    $isSchemaAdmin = $null -ne (whoami /groups | sls "\\Schema Admins\s+Group")
    if (-not $isSchemaAdmin) {
        Write-Warning "This user is not in Schema Admins. Cannot apply fix."
        return
    }

    Write-Host "Attempting to apply fix..."

    $rootDSE = [ADSI]("LDAP://$($schemaMaster)/RootDSE")
    [void]$rootDSE.Properties["schemaUpgradeInProgress"].Add(1)
    $rootDSE.CommitChanges()

    $storageGroupSchemaEntry.Properties["possSuperiors"].Clear()
    $storageGroupSchemaEntry.CommitChanges()

    Write-Host "Fix was applied successfully."
}

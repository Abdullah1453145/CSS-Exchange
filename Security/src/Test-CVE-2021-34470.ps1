# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

[CmdletBinding()]
param (
    [Parameter()]
    [switch]
    $ApplyFix
)

$ErrorActionPreference = "Stop"

$schemaMaster = (netdom query fsmo | sls "Schema master\s+(\S+)").Matches.Groups[1].Value

$schemaDN = ([ADSI]"LDAP://$($schemaMaster)/RootDSE").schemaNamingContext

$storageGroupSchemaEntryDN = "LDAP://$($schemaMaster)/CN=ms-Exch-Storage-Group,$schemaDN"

if (-not ([System.DirectoryServices.DirectoryEntry]::Exists($storageGroupSchemaEntryDN))) {
    Write-Host "Exchange was not installed in this forest. Therefore, CVE-2021-34470 vulnerability is not present."
    return
}

$storageGroupSchemaEntry = [ADSI]($storageGroupSchemaEntryDN)
if ($storageGroupSchemaEntry.Properties["possSuperiors"].Count -eq 0) {
    Write-Host "CVE-2021-34470 vulnerability is not present."
    return
}

foreach ($val in $storageGroupSchemaEntry.Properties["possSuperiors"]) {
    if ($val -eq "computer") {
        Write-Warning "CVE-2021-34470 vulnerability is present."
    } else {
        Write-Warning "CVE-2021-34470 vulnerability may be present due to an unexpected superior: $val"
    }
}

if ($ApplyFix) {
    Write-Host "Attempting to apply fix..."

    $rootDSE = [ADSI]("LDAP://$($schemaMaster)/RootDSE")
    [void]$rootDSE.Properties["schemaUpgradeInProgress"].Add(1)
    $rootDSE.CommitChanges()

    $storageGroupSchemaEntry.Properties["possSuperiors"].Clear()
    $storageGroupSchemaEntry.CommitChanges()

    Write-Host "Fix was applied successfully."
}

# CVE-2023-23397 script

Download the latest release: [CVE-2023-23397.ps1](https://github.com/microsoft/CSS-Exchange/releases/latest/download/CVE-2023-23397.ps1)

The CVE-2023-23397.ps1 is a script to help check messages (mails, calendar and task items) if PidLidReminderFileParameter property is populated or not. If required admins can use this script to cleanup the property for items they find malicious or even delete these items permanently. Please see [CVE-2023-23397](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-23397) for more information.

There are two modes in which we can run the script: Audit and Cleanup.

Audit Mode: Script provides a csv to the admins with details of items that have PidLidReminderFileParameter property populated.
Cleanup Mode: Script performs Cleanup action on items by either clearing the property or deleting the item itself.

## Requirements

Prerequisites to run the script for Exchange Server (on-premises): You need to have ApplicationImpersonation role.
You can create a new role group with the required permissions by running the following PowerShell command in an elevated Exchange Management Shell (EMS):
    `New-RoleGroup -Name "CVE-2023-23397-Script" -Roles "ApplicationImpersonation" -Description "Permission to run the CVE-2023-23397 script"`
The script uses Exchange Web Services (EWS) managed api to make EWS calls in order to fetch items from user mailboxes. So the machine on which the script is run should be able to make EWS calls to Exchange Server.

Prerequisites to run the script for Exchange Online: You need to be a member of Organization Management.
The script will create an application with full access permission on all the mailboxes.
For scanning cloud mailboxes, you need to install Azure-AD module in the PowerShell. Refer: [Install AzureAD PowerShell for Graph | Microsoft Learn](https://learn.microsoft.com/powershell/azure/active-directory/install-adv2?view=azureadps-2.0).

Note: The script uses Microsoft.Exchange.WebServices.dll to make EWS calls. The script will try to download the dll and use it. However, if it fails you will need to download the dll and provide the path. 

#### Steps to Download Microsoft.Exchange.WebServices.dll:
-  Download the nuget package from [NuGet Gallery | Exchange.WebServices.Managed.Api 2.2.1.2](https://www.nuget.org/api/v2/package/Exchange.WebServices.Managed.Api/2.2.1.2)
-  Change the extension of the file from .nupkg to .zip  
-  Unzip the package.  
-  Use the dll present at “\lib\net35” location in the package
-  Provide the path to the dll while running the script in DLLPath parameter

## How To Run

### Script Parameters

The script accepts the following parameters:

Parameter | Description
----------|------------
Environment | Provide the environment on which you are running the script on (Onprem/Online) This parameter is required while running in Audit/Cleanup mode
CreateAzureApplication | Use this switch to create a Azure AD application that can be used for running the script in Online mode.
DeleteAzureApplication | Use this switch to delete the Azure AD application.
UserMailboxes | Use this parameter to provide list of user primary SMTP address. You can pipe the addresses while running. This parameter is required in Audit mode.
StartTimeFilter | Use this parameter to provide start time filter. (Format: "mm/dd/yyyy hh:mm:ss")
EndTimeFilter | Use this parameter to provide end time filter. (Format: "mm/dd/yyyy hh:mm:ss")
CleanupAction | Use this parameter to provide type of cleanup action you want to perform (ClearProperty/ClearItem).
CleanupInfoFilePath | Use this parameter to provide path to the csv file containing the details of messages to be cleaned up.
EWSExchange2013 | Use this switch if you are running on Exchange Server 2013 mailboxes.
DLLPath | Provide the path to Microsoft.Exchange.WebServices.dll. This is an optional parameter.
AzureApplicationName | Provide the name of the application which the script should create. This is an optional parameter. (Default: CVE-2023-23397Application)
AzureEnvironmentName | Provide the Azure Environment name. This is an optional parameter (Default: AzureCloud)
MaxCSVLength | Provide the maximum number of rows the script should create in the csv while running in Audit mode. This is an optional parameter (Default: 200000)
AzureADEndpoint | Provide the Azure AD endpoint which the script should contact to get the authentication token for the app. This is an optional parameter (Default: https://login.microsoftonline.com/)
EWSOnlineURL | Provide the EWS endpoint. This is an optional parameter (Default: https://outlook.office365.com/EWS/Exchange.asmx)
EWSOnlineScope | Provide the EWS online scope. This is an optional parameter (Default: https://outlook.office365.com/.default)
EWSServerURL | Provide the EWS endpoint, if not provided the script will make an autodiscover call to get it. This parameter will only work while running on Exchange Server on-premises.
ScriptUpdateOnly | This optional parameter allows you to only update the script without performing any other actions.
SkipVersionCheck | This optional parameter allows you to skip the automatic version check and script update.
IgnoreCertificateMismatch | This optional parameter lets you ignore TLS certificate mismatch errors.
Credential | This optional parameter lets you pass administrator credential object while running on Exchange Server on-premises.

#### Set Exchange Online Cloud Specific values:
If you are on Word Wide (WW) cloud the values for AzureEnvironmentName, AzureADEndpoint, EWSOnlineURL and EWSOnlineScope can be left as default.

### Running Against Exchange Server (On-Premises) Mailboxes

#### Audit Mode:
Then execute the script in audit mode through an admin who has ApplicationImpersonation Role. For scanning on-premises mailboxes, the Environment value should be "Onprem" and optionally do provide the EWS URL of the Exchange Server in EWSServerURL. The script will ask for a login prompt, the username that is provided must be in UPN format where the username is the same as the email address. Optionally, the user can use the Credential flag to provide administrator credential in PSCredential format. Please set the EWSServerURL parameter to specify the EWS url if the AutoDiscover call fails.

##### Examples:
This syntax runs the script to audit all the mailboxes.

```powershell
PS C:\> (Get-Mailbox).PrimarySMTPAddress | .\CVE-2023-23397.ps1 -Environment Onprem
```

This syntax runs the script to audit all the mailboxes only on the items that were created between a specific time period.

```powershell
PS C:\> (Get-Mailbox).PrimarySMTPAddress | .\CVE-2023-23397.ps1 -Environment Onprem -StartTimeFilter "01/01/2023 00:00:00" -EndTimeFilter "01/01/2024 00:00:00"
```


#### Cleanup Mode:

The script provides a list of all the messages containing the vulnerable property in the mailboxes of users specified in an AuditResult_timestamp.CSV file. Admins should analyze this file and mark (with a "Y") messages for which either the property is to be cleaned or the message has to be removed. 

Step 1
Mark the messages for cleanup by entering “Y” instead of “N” in the cleanup column of CSV file.

Step 2
Admins can choose either to remove the malicious message or only the malicious property in the next step by specifying CleanupAction as “ClearItem” or “ClearProperty”. Execute the script as following to remove the message or property marked as Y in the CSV file.

##### Examples:
This syntax runs the script to clear the malicious property from messages

```powershell
PS C:\> .\CVE-2023-23397.ps1 -Environment Onprem -CleanupAction ClearProperty -CleanupInfoFilePath <Path to modified CSV>
```

This syntax runs the script to delete messages containing the malicious property

```powershell
PS C:\> .\CVE-2023-23397.ps1 -Environment Onprem -CleanupAction ClearItem -CleanupInfoFilePath <Path to modified CSV>
```

### Running Against Exchange Online Mailboxes

First execute the script in Audit mode through an admin who is part of Organization Management. For scanning online mailboxes, the Environment parameter should be "Online".

While scanning Exchange Online mailboxes, the script needs an Azure AD app that has delegate permissions for all the mailboxes hosted in the cloud. You can create the application using the script. And once the application is not required you can delete the application using the script as well. 
#### Managing AzureADApplication:
##### Examples:
This syntax runs the script to create an Azure application

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CreateAzureApplication
```

This syntax runs the script to delete the Azure application created by the script

```powershell
PS C:\> .\CVE-2023-23397.ps1 -DeleteAzureApplication
```

#### Audit Mode:
##### Examples:
This syntax runs the script to Audit all the mailboxes.

```powershell
PS C:\> (Get-Mailbox).PrimarySMTPAddress | .\CVE-2023-23397.ps1 -Environment "Online"
```

This syntax runs the script to Audit all the mailboxes only for the items that were created between a specific time period.

```powershell
PS C:\> (Get-Mailbox).PrimarySMTPAddress | .\CVE-2023-23397.ps1 -Environment "Online" -StartTimeFilter "01/01/2023 00:00:00" -EndTimeFilter "01/01/2024 00:00:00"
```

#### Cleanup Mode:
##### Examples:
This syntax runs the script to clear the malicious property from messages

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CleanupAction ClearProperty -CleanupInfoFilePath <Path to modified CSV>
```

This syntax runs the script to delete messages containing the malicious property

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CleanupAction ClearItem -CleanupInfoFilePath <Path to modified CSV>
```

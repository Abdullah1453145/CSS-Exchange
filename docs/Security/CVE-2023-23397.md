# CVE-2023-23397

Download the latest release: [CVE-2023-23397.ps1](https://github.com/microsoft/CSS-Exchange/releases/latest/download/CVE-2023-23397.ps1)

The CVE-2023-23397 is a script to help audits mails, calendar and task items and check if PidLidReminderFileParameter property is populated or not. If required admins can use this script to cleanup the property for items they find malicious or even delete these items permanently.

There are two modes in which we can run the script Audit and Cleanup.

Audit Mode: Script provides a csv to the admins with details of items that have PidLidReminderFileParameter property populated.
Cleanup Mode: Script performs Cleanup action on items by either clearing the property or deleting the mail itself.

## Requirements

Prerequisites to run the script for exchange onprem: You need to have ApplicationImpersonation role.
The script uses EWS managed api to make ews calls in order to fetch items from user mailboxes. So the machine on which the script is run should be able to make EWS calls to Exchange Server.

Prerequisites to run the script for exchange online: You need to be a member of Organization Management.
The script will create an application with full access permission on all the mailboxes.
For scanning cloud mailboxes, you need to install Azure-AD module in the PowerShell. Refer: [Install AzureAD PowerShell for Graph | Microsoft Learn](https://learn.microsoft.com/en-us/powershell/azure/active-directory/install-adv2?view=azureadps-2.0).

Note: The script uses Microsoft.Exchange.WebServices.dll to make EWS calls. The script will try to download the dll and use it. However, if it fails you will need to download the dll and provide the path. 

#### Steps to Download Microsoft.Exchange.WebServices.dll:
-  Download the nuget package from [NuGet Gallery | Exchange.WebServices.Managed.Api 2.2.1.2](https://www.nuget.org/packages/Exchange.WebServices.Managed.Api/#dependencies-body-tab)
-  Change the extension of the file from .nupkg to .zip  
-  Unzip the package.  
-  Copy the DLL present at “\lib\net35” location in the package and paste it in the script directory.

## How To Run
The script requires a config file which contains the following information:

Config Parameter | Required/Optional | Description | Default Value
-----------------|-------------------|-------------|---------------
Environment | Required | Provide the environment on which you are running the script on (Onprem/Online) | None
DLLPath | Optional | Provide the path to Microsoft.Exchange.WebServices.dll  | None
AzureApplicationName | Required for Online | Provide the name of the application which the script should create | CVE-2023-23397Application
AzureEnvironmentName | Required for Online | Provide the Azure Environment name | AzureCloud
MaxCSVLength | Required | Provide the maximum number of rows the script should create in the csv while running in audit mode | 1000
AzureADEndpoint | Require for Online | Provide the Azure AD endpoint which the script should reach out, to get the authentication token for the app | https://login.microsoftonline.com/
EWSOnlineURL | Required for Online | Provide the EWS endpoint | https://outlook.office365.com/EWS/Exchange.asmx
EWSOnlineScope | Require for Online | Provide the EWS online scope | https://outlook.office365.com/.default
EWSServerURL | Optional for Onprem | Provide the EWS endpoint, if not provided the script will make an autodiscover call to get it | None

#### Set Exchange Online Cloud Specific values:
If you are on Word Wide (WW) cloud the values for AzureEnvironmentName, AzureADEndpoint, EWSOnlineURL and EWSOnlineScope can be left as default.

You can have a look at the sample config file present. Place the config file in the same directory as the script.

### Script Parameters

The script accepts the following parameters:

Parameter | Description
----------|------------
CreateAzureApplication | Use this switch to create a Azure AD application that can be used for running the script in online mode.
DeleteAzureApplication | Use this switch to delete the Azure AD application.
UserMailboxesFilePath | Use this parameter to provide path to the file containing list of UserAddresses to audit. You need to provide a text file with new line separated list of user addresses.
StartTimeFilter | Use this parameter to provide start time filter. (Format: "mm/dd/yyyy hh:mm:ss")
EndTimeFilter | Use this parameter to provide end time filter. (Format: "mm/dd/yyyy hh:mm:ss")
CleanupAction | Use this parameter to provide type of cleanup action you want to provide (ClearProperty/ClearItem).
CleanupInfoFilePath | Use this parameter to provide path to the csv file containing the details of emails to be cleaned up.
EWSExchange2013 | Use this switch if you are running on Exchange 2013 server mailboxes.
ScriptUpdateOnly | This optional parameter allows you to only update the script without performing any other actions.
SkipVersionCheck | This optional parameter allows you to skip the automatic version check and script update.
IgnoreCertificateMismatch | This optional parameter lets you ignore TLS certificate mismatch errors.

### On-Premises Mailboxes

#### Audit Mode:
To scan infected emails in the on-premises mailboxes, first create a list of all the mailboxes in a TXT files. The files should contain only the email addresses of all the mailboxes to be scanned separated by a newline character (each row should contain only one email address). 

Then execute the script in audit mode through an admin who has ApplicationImpersonation Role. For scanning on-premises mailboxes, the Environment config value should be "Onprem" and optionally do provide the EWS URL of the Exchange Server in EWSServerURL. 

##### Examples:
This syntax runs the script to audit all the mailboxes present in the file provided.

```powershell
PS C:\> .\CVE-2023-23397.ps1 -UserMailboxesFilePath <path to text file>
```

This syntax runs the script to audit all the mailboxes present in the file provided only on the items that were created between a specific time period.

```powershell
PS C:\> .\CVE-2023-23397.ps1 -UserMailboxesFilePath <path to text file> -StartTimeFilter "01/01/2023 00:00:00" -EndTimeFilter "01/01/2024 00:00:00"
```

This syntax will enable Extended Protection for all virtual directories and set EWS Backend virtual directory to None and then proceed to set IP restriction for the EWS Backend virtual directory for all servers online, while providing the IP address list.

#### Cleanup Mode:

The script provides a list of all the vulnerable emails in the mailboxes of users specified in an AuditResult_timestamp.CSV file. Admins should analyze this file and mark Y against the emails for which either the property is to be cleaned or the mail has to be removed. 

Step 1
Mark the emails for cleanup by putting “Y” in place of “N” in the cleanup column of CSV file.

Step 2
Admins can choose either to remove the malicious email or only the malicious property in the next step by specifying CleanupAction as “ClearItem” or “ClearProperty”. Execute the script as following to remove the email or property marked as Y in the CSV file.

##### Examples:
This syntax runs the script to clear the malicious property of the mails

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CleanupAction ClearProperty -CleanupInfoFilePath <Path to modified CSV>
```

This syntax runs the script to clear the malicious mail items

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CleanupAction ClearItem -CleanupInfoFilePath <Path to modified CSV>
```

### Online Mailboxes
To scan infected emails in the cloud, first create a list of all the mailboxes in a TXT files. The files should contain only the email addresses of all the mailboxes to be scanned separated by a newline character (each row should contain only one email address). 

Then execute the script in audit mode through an admin who is part of Organization Management. For scanning online mailboxes, the Environment config parameter should be "Online" depending on the cloud instance where the mailbox is located.

While scanning mailboxes in online, the script needs an Azure AD app that has delegate permissions for all the mailboxes hosted in cloud. You can create the application using the script. And once the application is not required you can delete the application using the script as well. 
#### Managing AzureADApplication:
##### Examples:
This syntax runs the script to create an azure application

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CreateAzureApplication
```

This syntax runs the script to delete the azure application created by the script

```powershell
PS C:\> .\CVE-2023-23397.ps1 -DeleteAzureApplication
```

#### Audit Mode:
##### Examples:
This syntax runs the script to audit all the mailboxes present in the file provided.

```powershell
PS C:\> .\CVE-2023-23397.ps1 -UserMailboxesFilePath <path to text file>
```

This syntax runs the script to audit all the mailboxes present in the file provided only on the items that were created between a specific time period.

```powershell
PS C:\> .\CVE-2023-23397.ps1 -UserMailboxesFilePath <path to text file> -StartTimeFilter "01/01/2023 00:00:00" -EndTimeFilter "01/01/2024 00:00:00"
```

This syntax will enable Extended Protection for all virtual directories and set EWS Backend virtual directory to None and then proceed to set IP restriction for the EWS Backend virtual directory for all servers online, while providing the IP address list.

#### Cleanup Mode:
##### Examples:
This syntax runs the script to clear the malicious property of the mails

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CleanupAction ClearProperty -CleanupInfoFilePath <Path to modified CSV>
```

This syntax runs the script to clear the malicious mail items

```powershell
PS C:\> .\CVE-2023-23397.ps1 -CleanupAction ClearItem -CleanupInfoFilePath <Path to modified CSV>
```

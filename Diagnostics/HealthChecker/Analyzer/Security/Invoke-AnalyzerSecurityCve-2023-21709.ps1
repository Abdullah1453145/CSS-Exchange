# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\Add-AnalyzedResultInformation.ps1
function Invoke-AnalyzerSecurityCve-2023-21709 {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ref]$AnalyzeResults,

        [Parameter(Mandatory = $true)]
        [object]$SecurityObject,

        [Parameter(Mandatory = $true)]
        [object]$DisplayGroupingKey
    )

    Write-Verbose "Calling: $($MyInvocation.MyCommand)"

    <#
        Description: Check for CVE-2023-21709 vulnerability
        Affected Exchange versions: 2016, 2019
        Fix: Remove TokenCacheModule from IIS
        Workaround: N/A
    #>

    if ($SecurityObject.IsEdgeServer -eq $false) {
        Write-Verbose "Testing CVE: CVE-2023-21709"

        if ($SecurityObject.ExchangeInformation.IISSettings.IISModulesInformation.ModuleList.Name -contains "TokenCacheModule") {
            Write-Verbose "TokenCacheModule detected - system is vulnerable to CVE-2023-21709 vulnerability"
            $params = @{
                AnalyzedInformation = $AnalyzeResults
                DisplayGroupingKey  = $DisplayGroupingKey
                Name                = "Security Vulnerability"
                Details             = ("{0}`r`n`t`tSee: https://portal.msrc.microsoft.com/security-guidance/advisory/{0} for more information." -f "CVE-2023-21709")
                DisplayWriteType    = "Red"
                DisplayTestingValue = "CVE-2023-21709"
                AddHtmlDetailRow    = $false
            }
            Add-AnalyzedResultInformation @params
        } else {
            Write-Verbose "TokenCacheModule wasn't detected and as a result, system is not vulnerable to CVE-2023-21709 vulnerability"
        }
    } else {
        Write-Verbose "Edge Server Role is not affected by this vulnerability as it has no IIS installed"
    }
}

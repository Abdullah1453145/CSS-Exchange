# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\Add-AnalyzedResultInformation.ps1
. $PSScriptRoot\..\..\..\..\Shared\ScriptBlockFunctions\RemotePipelineHandlerFunctions.ps1
function Invoke-AnalyzerSecurityCve-2025-25007 {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ref]$AnalyzeResults,

        [Parameter(Mandatory = $true)]
        [object]$SecurityObject,

        [Parameter(Mandatory = $true)]
        [object]$DisplayGroupingKey
    )
    <#
        Description: Check for CVE-2025-25007
        Affected Exchange Versions: 2016, 2019, SE
        Fix: Install August 2025 SU + No Override set to disable the security vulnerability
    #>
    process {
        Write-Verbose "Calling: $($MyInvocation.MyCommand)"
        $exchangeInformation = $SecurityObject.ExchangeInformation
        $organizationInformation = $SecurityObject.OrgInformation
        $exchangeBuild = $exchangeInformation.BuildInformation.VersionInformation.BuildVersion
        $params = @{
            ExchangeSettingOverride = $exchangeInformation.SettingOverrides
            GetSettingOverride      = $organizationInformation.GetSettingOverride
            FilterServer            = $exchangeInformation.GetExchangeServer.Name
            FilterServerVersion     = $exchangeBuild
            FilterComponentName     = "Transport"
            FilterSectionName       = "NonCompliantSenderSettings"
            FilterParameterName     = "BlockCharactersAfterUnquotedSemicolon"
        }
        [array]$transportCompliantSender = $null
        Get-FilteredSettingOverrideInformation @params | Invoke-RemotePipelineHandlerList -Result ([ref]$transportCompliantSender)

        $overrideDisabled = $transportCompliantSender.Count -gt 0 -and
        ($null -ne ($transportCompliantSender | Where-Object { $_.ParameterValue -eq "false" }))
        $isSuApplied = $null
        Test-ExchangeBuildGreaterOrEqualThanSecurityPatch -CurrentExchangeBuild $SecurityObject.BuildInformation -SUName "Aug25SU" |
            Invoke-RemotePipelineHandler -Result ([ref]$isSuApplied)

        if (-not $isSuApplied -or $overrideDisabled) {
            $params = @{
                AnalyzedInformation = $AnalyzeResults
                DisplayGroupingKey  = $DisplayGroupingKey
                Name                = "Security Vulnerability"
                Details             = ("{0}$(if($overrideDisabled){" - Disabled By Override"})`r`n`t`tSee: https://portal.msrc.microsoft.com/security-guidance/advisory/{0} for more information." -f "CVE-2025-25007")
                DisplayWriteType    = "Red"
                DisplayTestingValue = "CVE-2025-25007"
            }
            Add-AnalyzedResultInformation @params
        }
    }
}
